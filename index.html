<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ”ç©¶å®¤è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .result {
            margin-top: 30px;
            padding: 20px;
            background-color: #ecf0f1;
            border-radius: 5px;
        }
        .result-item {
            margin: 15px 0;
            padding: 10px;
            border-left: 4px solid #3498db;
            background-color: white;
        }
        .probability-100 { border-left-color: #27ae60; }
        .probability-75 { border-left-color: #2ecc71; }
        .probability-50 { border-left-color: #f39c12; }
        .probability-25 { border-left-color: #e67e22; }
        .probability-low { border-left-color: #e74c3c; }
        .loading {
            display: none;
            text-align: center;
            color: #3498db;
            margin: 10px 0;
        }
        .debug {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 12px;
            display: none;
        }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .admin-panel {
            margin-top: 20px;
            padding: 15px;
            background: #34495e;
            border-radius: 5px;
            text-align: center;
        }
        .admin-btn {
            background-color: #95a5a6;
            color: white;
            border: none;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .admin-btn:hover {
            background-color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ç ”ç©¶å®¤è¨ºæ–­ã‚·ã‚¹ãƒ†ãƒ </h1>
        
        <div class="form-group">
            <label for="gpa">ã‚ãªãŸã®GPA</label>
            <input type="number" id="gpa" step="0.1" min="0" max="4.0" placeholder="0.0 ~ 4.0">
        </div>

        <div class="form-group">
            <label for="firstChoice">ç¬¬ä¸€å¸Œæœ›ç ”ç©¶å®¤</label>
            <select id="firstChoice">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
        </div>

        <div class="form-group">
            <label for="secondChoice">ç¬¬äºŒå¸Œæœ›ç ”ç©¶å®¤</label>
            <select id="secondChoice">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
        </div>

        <div class="form-group">
            <label for="thirdChoice">ç¬¬ä¸‰å¸Œæœ›ç ”ç©¶å®¤</label>
            <select id="thirdChoice">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
        </div>

        <button onclick="calculateProbability()">è¨ºæ–­ã™ã‚‹</button>
        <div id="loading" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ä¸­...</div>

        <div id="debug" class="debug">
            <strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong>
            <div id="debugInfo"></div>
        </div>

        <div id="result" class="result" style="display: none;">
            <h2>ğŸ¯ è¨ºæ–­çµæœ</h2>
            <div id="resultContent"></div>
        </div>

        <!-- ç®¡ç†è€…ç”¨ãƒ‘ãƒãƒ« -->
        <div class="admin-panel">
            <strong style="color: white;">ç®¡ç†è€…ç”¨</strong>
            <button class="admin-btn" onclick="exportLocalData()">ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            <button class="admin-btn" onclick="showDataStats()">çµ±è¨ˆè¡¨ç¤º</button>
            <button class="admin-btn" onclick="clearLocalData()">ãƒ‡ãƒ¼ã‚¿æ¶ˆå»</button>
        </div>
    </div>

    <script>
        // Google Apps Scriptã®URL
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxVRF-7S9VdypJiHrVe7fcVcSeVGxNA3XqIqnrVAuY/dev
        // ç ”ç©¶å®¤ãƒ‡ãƒ¼ã‚¿
        const labData = [
            { name: "æ°´æ—ç”Ÿç†å­¦ç ”ç©¶å®¤ï¼ˆå“å·)", capacity: 7, applicants: 1, gpa100: 1.0, gpa75: 1.0, gpa50: 1.0, gpa25: 1.0 },
            { name: "æ°´æ—ç”Ÿç†å­¦ç ”ç©¶å®¤ï¼ˆé¤¨å±±)", capacity: 3, applicants: 3, gpa100: 1.0, gpa75: 1.0, gpa50: 1.0, gpa25: 1.0 },
            { name: "æ°´æ—ç”Ÿç†å­¦ç ”ç©¶å®¤ï¼ˆå¤§æ³‰)", capacity: 3, applicants: 3, gpa100: 1.0, gpa75: 1.0, gpa50: 1.0, gpa25: 1.0 },
            { name: "æ°´æ—ç—…ç†å­¦ç ”ç©¶å®¤", capacity: 8, applicants: 13, gpa100: 3.0, gpa75: 3.5, gpa50: 3.5, gpa25: 3.5 },
            { name: "æ°´æ—æ „é¤Šå­¦ç ”ç©¶å®¤", capacity: 6, applicants: 6, gpa100: 1.0, gpa75: 1.0, gpa50: 1.0, gpa25: 1.0 },
            { name: "æ°´æ—é¤Šæ®–å­¦ç ”ç©¶å®¤", capacity: 8, applicants: 3, gpa100: 1.0, gpa75: 1.0, gpa50: 1.0, gpa25: 1.0 },
            { name: "å¿œç”¨è—»é¡å­¦ç ”ç©¶å®¤", capacity: 6, applicants: 9, gpa100: 3.0, gpa75: 3.0, gpa50: 3.5, gpa25: 3.5 },
            { name: "é›†å›£ç”Ÿç‰©å­¦ç ”ç©¶å®¤", capacity: 7, applicants: 10, gpa100: 3.0, gpa75: 3.0, gpa50: 3.5, gpa25: 3.5 },
            { name: "å¢—æ®–ç”Ÿæ…‹å­¦ç ”ç©¶å®¤", capacity: 5, applicants: 6, gpa100: 2.5, gpa75: 3.0, gpa50: 3.5, gpa25: 3.5 },
            { name: "è³‡æºè§£æå­¦ç ”ç©¶å®¤", capacity: 6, applicants: 4, gpa100: 1.0, gpa75: 1.0, gpa50: 1.0, gpa25: 1.0 },
            { name: "é­šç¾¤åˆ¶å¾¡å­¦ç ”ç©¶å®¤", capacity: 5, applicants: 2, gpa100: 1.0, gpa75: 1.0, gpa50: 1.0, gpa25: 1.0 },
            { name: "ç”Ÿç”£ã‚·ã‚¹ãƒ†ãƒ å­¦ç ”ç©¶å®¤", capacity: 5, applicants: 6, gpa100: 2.5, gpa75: 3.0, gpa50: 3.5, gpa25: 3.5 },
            { name: "ã‚²ãƒãƒ ç§‘å­¦ç ”ç©¶å®¤", capacity: 7, applicants: 1, gpa100: 1.0, gpa75: 1.0, gpa50: 1.0, gpa25: 1.0 },
            { name: "å…ˆç«¯é­šé¡é˜²ç–«å­¦ç ”ç©¶å®¤", capacity: 4, applicants: 0, gpa100: 1.0, gpa75: 1.0, gpa50: 1.0, gpa25: 1.0 },
            { name: "å¿œç”¨å¾®ç”Ÿç‰©ç ”ç©¶å®¤", capacity: 5, applicants: 3, gpa100: 1.0, gpa75: 1.0, gpa50: 1.0, gpa25: 1.0 }
        ];

        // ç ”ç©¶å®¤é¸æŠè‚¢ã‚’è¿½åŠ 
        function populateLabOptions() {
            const selects = ['firstChoice', 'secondChoice', 'thirdChoice'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆã€Œé¸æŠã—ã¦ãã ã•ã„ã€ä»¥å¤–ï¼‰
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
                labData.forEach(lab => {
                    const option = document.createElement('option');
                    option.value = lab.name;
                    option.textContent = lab.name;
                    select.appendChild(option);
                });
            });
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
        function showDebugInfo(message, type = 'info') {
            document.getElementById('debug').style.display = 'block';
            const colorClass = type === 'error' ? 'error' : (type === 'success' ? 'success' : '');
            document.getElementById('debugInfo').innerHTML += `<div class="${colorClass}">${new Date().toLocaleTimeString()}: ${message}</div>`;
        }

        // åˆæ ¼ç¢ºç‡ã‚’è¨ˆç®—
        async function calculateProbability() {
            const gpa = parseFloat(document.getElementById('gpa').value);
            const firstChoice = document.getElementById('firstChoice').value;
            const secondChoice = document.getElementById('secondChoice').value;
            const thirdChoice = document.getElementById('thirdChoice').value;

            if (!gpa || gpa < 0 || gpa > 4.0) {
                alert('æœ‰åŠ¹ãªGPAã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ0.0ã€œ4.0ï¼‰');
                return;
            }

            let resultHTML = '';
            const results = [];

            // å„å¸Œæœ›ã®ç¢ºç‡ã‚’è¨ˆç®—
            [firstChoice, secondChoice, thirdChoice].forEach((choice, index) => {
                if (!choice) return;

                const lab = labData.find(l => l.name === choice);
                if (!lab) return;

                const probability = calculateLabProbability(gpa, lab);
                const advice = getAdvice(probability);
                const className = getProbabilityClass(probability);
                
                results.push(probability);

                resultHTML += `
                    <div class="result-item ${className}">
                        <strong>ç¬¬${index + 1}å¸Œæœ›: ${lab.name}</strong><br>
                        <span style="font-size: 1.2em; font-weight: bold;">${probability}</span><br>
                        ${advice}
                    </div>
                `;
            });

            if (!resultHTML) {
                resultHTML = '<p>ç ”ç©¶å®¤ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>';
            }

            document.getElementById('resultContent').innerHTML = resultHTML;
            document.getElementById('result').style.display = 'block';
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
            await sendDataToServer(gpa, firstChoice, secondChoice, thirdChoice, results);
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
        async function sendDataToServer(gpa, firstChoice, secondChoice, thirdChoice, results) {
            const data = {
                timestamp: new Date().toISOString(),
                gpa: gpa,
                firstChoice: firstChoice,
                secondChoice: secondChoice,
                thirdChoice: thirdChoice,
                result1: results[0] || 'æœªé¸æŠ',
                result2: results[1] || 'æœªé¸æŠ',
                result3: results[2] || 'æœªé¸æŠ'
            };

            showDebugInfo(`é€ä¿¡ãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(data)}`);

            try {
                document.getElementById('loading').style.display = 'block';
                showDebugInfo('Google Apps Scriptã«é€ä¿¡é–‹å§‹...');

                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜
                saveToLocalStorage(data);
                showDebugInfo('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜');

                // GitHub Pagesã‹ã‚‰ã¯é€šå¸¸ã®fetchãŒä½¿ãˆã‚‹
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }

                const result = await response.json();
                showDebugInfo(`âœ… é€ä¿¡æˆåŠŸ: ${result.message}`, 'success');
                showDebugInfo(`ã‚µãƒ¼ãƒãƒ¼å¿œç­”: ${JSON.stringify(result)}`, 'success');
                
            } catch (error) {
                console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                showDebugInfo(`âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                showDebugInfo('âš ï¸ é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ãƒ­ãƒ¼ã‚«ãƒ«ã«ã¯ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™', 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
        function saveToLocalStorage(data) {
            try {
                const logs = JSON.parse(localStorage.getItem('lab_diagnosis_logs') || '[]');
                logs.push(data);
                localStorage.setItem('lab_diagnosis_logs', JSON.stringify(logs));
                return true;
            } catch (error) {
                console.error('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }

        // ç ”ç©¶å®¤ã”ã¨ã®ç¢ºç‡è¨ˆç®—
        function calculateLabProbability(gpa, lab) {
            if (lab.applicants <= lab.capacity) {
                return "100%";
            }

            if (gpa >= lab.gpa100) return "100%";
            if (gpa >= lab.gpa75) return "75%";
            if (gpa >= lab.gpa50) return "50%";
            if (gpa >= lab.gpa25) return "25%";
            return "10%ä»¥ä¸‹";
        }

        // ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å–å¾—
        function getAdvice(probability) {
            switch(probability) {
                case "100%": return "ğŸ‰ ç¢ºå®Ÿã«åˆæ ¼åœå†…ã§ã™ï¼";
                case "75%": return "âœ… é«˜ã„ç¢ºç‡ã§åˆæ ¼ã§ãã¾ã™";
                case "50%": return "âš ï¸ äº”åˆ†äº”åˆ†ã®å‹è² ã§ã™";
                case "25%": return "â— ã‚„ã‚„å³ã—ã„çŠ¶æ³ã§ã™";
                case "10%ä»¥ä¸‹": return "ğŸ’¡ ä»–ã®ç ”ç©¶å®¤ã‚‚æ¤œè¨ã—ã¾ã—ã‚‡ã†";
                default: return "";
            }
        }

        // ç¢ºç‡ã«å¿œã˜ãŸã‚¯ãƒ©ã‚¹ã‚’å–å¾—
        function getProbabilityClass(probability) {
            switch(probability) {
                case "100%": return "probability-100";
                case "75%": return "probability-75";
                case "50%": return "probability-50";
                case "25%": return "probability-25";
                case "10%ä»¥ä¸‹": return "probability-low";
                default: return "";
            }
        }

        // ç®¡ç†è€…æ©Ÿèƒ½ - ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportLocalData() {
            const logs = JSON.parse(localStorage.getItem('lab_diagnosis_logs') || '[]');
            
            if (logs.length === 0) {
                alert('ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            // CSVå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            let csv = 'ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—,GPA,ç¬¬1å¸Œæœ›,ç¬¬2å¸Œæœ›,ç¬¬3å¸Œæœ›,çµæœ1,çµæœ2,çµæœ3\n';
            
            logs.forEach(log => {
                csv += `"${log.timestamp}",${log.gpa},"${log.firstChoice}","${log.secondChoice}","${log.thirdChoice}","${log.result1}","${log.result2}","${log.result3}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ç ”ç©¶å®¤è¨ºæ–­ãƒ‡ãƒ¼ã‚¿_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`${logs.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
        }

        // ç®¡ç†è€…æ©Ÿèƒ½ - ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆè¡¨ç¤º
        function showDataStats() {
            const logs = JSON.parse(localStorage.getItem('lab_diagnosis_logs') || '[]');
            
            if (logs.length === 0) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            console.group('ğŸ“Š åé›†ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ');
            console.log(`ç·ãƒ‡ãƒ¼ã‚¿æ•°: ${logs.length}ä»¶`);
            console.log('æœ€æ–°5ä»¶ã®ãƒ‡ãƒ¼ã‚¿:', logs.slice(-5));
            
            // äººæ°—ç ”ç©¶å®¤ãƒ©ãƒ³ã‚­ãƒ³ã‚°
            const labCount = {};
            logs.forEach(log => {
                if (log.firstChoice) labCount[log.firstChoice] = (labCount[log.firstChoice] || 0) + 1;
                if (log.secondChoice) labCount[log.secondChoice] = (labCount[log.secondChoice] || 0) + 1;
                if (log.thirdChoice) labCount[log.thirdChoice] = (labCount[log.thirdChoice] || 0) + 1;
            });
            
            const sortedLabs = Object.entries(labCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            console.log('äººæ°—ç ”ç©¶å®¤TOP5:');
            sortedLabs.forEach(([lab, count], index) => {
                console.log(`  ${index + 1}. ${lab}: ${count}å›`);
            });
            
            console.groupEnd();
            alert(`${logs.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºã—ã¾ã—ãŸï¼ˆF12ã§ç¢ºèªï¼‰`);
        }

        // ç®¡ç†è€…æ©Ÿèƒ½ - ãƒ‡ãƒ¼ã‚¿æ¶ˆå»
        function clearLocalData() {
            if (confirm('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('lab_diagnosis_logs');
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã—ãŸ');
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ç ”ç©¶å®¤é¸æŠè‚¢ã‚’è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            populateLabOptions();
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿æ•°ã‚’è¡¨ç¤º
            const logs = JSON.parse(localStorage.getItem('lab_diagnosis_logs') || '[]');
            if (logs.length > 0) {
                showDebugInfo(`ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã« ${logs.length} ä»¶ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™`);
            }
        });
    </script>
</body>
</html>
